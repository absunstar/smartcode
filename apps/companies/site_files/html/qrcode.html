<!DOCTYPE html>
<html lang="En" data-ng-app="myApp">
  <head x-import="head.html"> </head>

  <body class="##session.lang## loaded">
    <div x-import="site-top/index.html"></div>
    <div x-import="site-bottom/index.html"></div>
    <div id="main-layout" class="container" ng-controller="test">
      <div class="row padding">
        <i-control class="col9" ng-model="code" label="QR Code" ng-change="readQR()"> </i-control>
      </div>
      <div class="row padding border">
        <i-control id2="qr1" class="row" ng-model="qr.code" label="Code" ng-disabled="true"></i-control>
        <i-control class="col6" ng-model="qr.gtin" label="GTIN"></i-control>
        <i-control class="col6" ng-model="qr.batch" label="BATCH"></i-control>
        <i-control class="col6" ng-model="qr.mfgDate" label="MFG DATE"></i-control>
        <i-control class="col6" ng-model="qr.expiryDate" label="EXPIRE DATE"></i-control>
        <i-control class="col6" ng-model="qr.sn" label="SERIAL NUMBER"></i-control>
      </div>
    </div>

    <div x-import="scripts.html"></div>
    <script>
      site.getQRcode = function (code) {
        let qr = {
          code: code,
        };
        if (code.indexOf('') !== -1) {
          code = code.split('');
        } else if (code.indexOf('^') !== -1) {
          code = code.split('^');
        }

        if (code[0].length === 24 && code[0].slice(0, 2) === '01' && code[0].slice(16, 18) === '10') {
          qr.gtin = code[0].slice(2, 16);
          qr.batch = code[0].slice(18);
        } else if (code[0].length === 24 && code[0].slice(0, 2) === '01') {
          qr.gtin = code[0].slice(2, 15);
          qr.mfgDate = code[0].slice(16, 23);
        } else if (code[0].length === 32 && code[0].slice(0, 2) === '01' && code[0].slice(16, 18) === '17') {
          qr.gtin = code[0].slice(2, 15);
          qr.expiryDate = code[0].slice(18, 24);
          qr.batch = code[0].slice(25);
        } else if (code[0].length === 32 && code[0].slice(0, 2) === '01' && code[0].slice(16, 18) === '21') {
          qr.gtin = code[0].slice(2, 15);
          qr.sn = code[0].slice(18);
        } else if (code[0].length === 25 && code[0].slice(0, 2) === '01') {
          qr.gtin = code[0].slice(1, 12);
          qr.mfgDate = code[0].slice(12, 18);
          qr.batch = code[0].slice(18);
        } else if (code[0].length === 33 && code[0].slice(0, 2) === '01' && code[0].slice(16, 18) === '17' && code[0].slice(24, 26) === '10') {
          qr.gtin = code[0].slice(2, 16);
          qr.expiryDate = code[0].slice(18, 24);
          qr.batch = code[0].slice(26);
        }

        if (code[1].length === 22 && code[1].slice(0, 2) === '17' && code[1].slice(8, 10) === '21') {
          qr.expiryDate = code[1].slice(2, 8);
          qr.sn = code[1].slice(10);
        } else if (code[1].length === 22 && code[1].slice(0, 2) === '21') {
          qr.sn = code[1].slice(2);
        } else if (code[1].length === 24 && code[1].slice(0, 2) === '17' && code[1].slice(8, 10) === '21') {
          qr.expiryDate = code[1].slice(2, 8);
          qr.sn = code[1].slice(10);
        } else if (code[1].length === 11 && code[1].slice(0, 2) === '21') {
          qr.sn = code[1].slice(2, 8);
        }else if (code[1].length === 17 && code[1].slice(0, 2) === '21') {
          qr.sn = code[1].slice(2);
        }else if (code[1].length === 17 && code[1].slice(0, 2) === '17'&& code[1].slice(8, 10) === '10') {
          qr.expiryDate = code[1].slice(2, 8);
          qr.batch = code[1].slice(10);
        }else if (code[1].length === 20 && code[1].slice(0, 2) === '17'&& code[1].slice(8, 10) === '21') {
          qr.expiryDate = code[1].slice(2, 8);
          qr.sn = code[1].slice(10);
        }

        console.log(qr);
        console.log(code);
        return qr;
      };

      app.controller('test', function ($scope, $http, $timeout) {
        $scope.code = '';
        $('#qr1').focus();
        $scope.readQR = function () {
          $timeout(() => {
            if ($scope.code) {
              $scope.qr = site.getQRcode($scope.code);
              $scope.code = '';
              $('#qr1').focus();
            }
          }, 300);
        };
      });
    </script>
  </body>
</html>
